stages:
  - build
  - deploy

variables:
  IMAGE_NAME: r-open-webui

build_image:
  stage: build
  variables:
    VERSION_TAG: ${CI_COMMIT_TAG}
  tags:
    - windows
    - shell
  script:
    - $JSON_VERSION = $(node -p "require('./package.json').version")
    - echo "Package version $JSON_VERSION"
    - docker build -f Dockerfile.renesas -t ${IMAGE_NAME}:${VERSION_TAG} .
    - docker save -o image.tar ${IMAGE_NAME}:${VERSION_TAG}
    - docker rmi ${IMAGE_NAME}:${VERSION_TAG}
    - bash -c "split -b 200000000 image.tar image.tar.part-" # Split the tar file into 200MB parts
  artifacts:
    paths:
      - image.tar.part-* # Upload all the parts as artifacts
  rules:
    - if: $CI_COMMIT_TAG =~ /^r.*/

.deploy_template: &deploy_template
  stage: deploy
  tags:
    - linux
    - deploy
    - web
  variables:
    VERSION_TAG: ${VERSION_TAG}
  script:
    - export DATABRICKS_CLIENT_ID=$DATABRICKS_CLIENT_ID
    - export DATABRICKS_CLIENT_SECRET=$DATABRICKS_CLIENT_SECRET
    # Function to check and load image
    - |
      check_and_load_image() {
        local image_full_name="${IMAGE_NAME}:${VERSION_TAG}"
      
        if docker image inspect "$image_full_name" >/dev/null 2>&1; then
          echo "‚úÖ Image $image_full_name already exists locally"
          return 0
        fi
      
        echo "üì• Image $image_full_name not found, downloading artifacts..."
      
        if ! curl --fail --location --output artifacts.zip --url "https://jc.gitlab.renesasworkbench.com/api/v4/projects/$CI_PROJECT_ID/jobs/$TARGET_JOB_ID/artifacts?job_token=$CI_JOB_TOKEN"; then
          echo "‚ùå Failed to download artifacts"
          return 1
        fi
      
        echo "üì¶ Extracting and loading image..."
        unzip -o "artifacts.zip" -d "./"
        cat image.tar.part-* > image.tar
      
        if docker load -i image.tar; then
          echo "‚úÖ Image loaded successfully"
          # Verify the loaded image has the expected tag
          if docker image inspect "$image_full_name" >/dev/null 2>&1; then
            echo "‚úÖ Verified image $image_full_name is available"
          else
            echo "‚ö†Ô∏è  Warning: Expected image tag $image_full_name not found after loading"
            docker images | grep "$IMAGE_NAME" || echo "No images found for $IMAGE_NAME"
          fi
        else
          echo "‚ùå Failed to load image"
          return 1
        fi
      
        # Clean up
        rm -f artifacts.zip image.tar image.tar.part-*
      }
    - check_and_load_image
    - docker compose -f $COMPOSE_FILE up --force-recreate -d
    - docker system prune -af

# Rest remains the same...
deploy_production:
  <<: *deploy_template
  variables:
    VERSION_TAG: ${VERSION_TAG}
    COMPOSE_FILE: docker-compose.renesas.yaml
  before_script:
    - cp $SSL_CRT ./ssl/nginx.crt
    - cp $SSL_KEY ./ssl/nginx.key
  rules:
    - if: '$SOURCE_TRIGGER == "request_deploy_production"'

deploy_development:
  <<: *deploy_template
  variables:
    VERSION_TAG: ${VERSION_TAG}
    COMPOSE_FILE: docker-compose.renesas.dev.yaml
  rules:
    - if: '$SOURCE_TRIGGER == "request_deploy_development"'